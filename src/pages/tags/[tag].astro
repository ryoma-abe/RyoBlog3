---
// src/pages/tags/[tag].astro

import Layout from "../../layouts/Layout.astro";
import BlogArea from "../../components/blog/BlogArea.astro";
import { getNotionPosts } from "../../lib/api/notion";

export async function getStaticPaths() {
  const allPosts = await getNotionPosts();

  // すべてのタグを抽出
  const allTags = allPosts.flatMap((post) => {
    const tags = (post.properties.Tags as any)?.multi_select || [];
    return tags.map((tag: { name: string }) => tag.name);
  });

  // 重複を削除
  const uniqueTags = [...new Set(allTags)].filter(Boolean);

  // データがない場合でもページが生成されるようにダミータグを追加
  if (uniqueTags.length === 0) {
    uniqueTags.push("CSS", "HTML", "JavaScript", "Astro");
  }

  return uniqueTags.map((tag) => {
    // そのタグを持つ投稿をフィルタリング
    const filteredPosts = allPosts.filter((post) => {
      const postTags = (post.properties.Tags as any)?.multi_select || [];
      return postTags.some((t: { name: string }) => t.name === tag);
    });

    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { posts } = Astro.props;
const { tag } = Astro.params;
---

<Layout title={`${tag}の記事一覧`}>
  <div class="px-4 py-8">
    {
      posts.length === 0 ? (
        <p class="text-center text-gray-500">記事が見つかりませんでした</p>
      ) : (
        <BlogArea customPosts={posts} />
      )
    }
  </div>
</Layout>
